name: Deploy PR to Beta (Cloudflare)

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  deploy-to-cloudflare-beta:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout PR code
      uses: actions/checkout@v4
      with:
        submodules: 'true'
        ref: ${{ github.event.pull_request.head.sha }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build
      run: npm run build

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps chromium

    - name: Run E2E tests
      run: npm run test:e2e
      continue-on-error: true

    - name: Upload test results on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report-pr-${{ github.event.pull_request.number }}
        path: playwright-report/
        retention-days: 7

    - name: Create deployment info
      run: |
        cat > dist/deployment-info.json << EOF
        {
          "pr_number": "${{ github.event.pull_request.number }}",
          "pr_title": "${{ github.event.pull_request.title }}",
          "pr_author": "${{ github.event.pull_request.user.login }}",
          "deployed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "commit_sha": "${{ github.event.pull_request.head.sha }}"
        }
        EOF

    - name: Deploy to Cloudflare Pages
      id: cloudflare_deploy
      uses: cloudflare/wrangler-action@v3
      continue-on-error: true
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        command: pages deploy dist --project-name=${{ vars.CLOUDFLARE_PROJECT_NAME }}

    - name: Comment on PR - Success
      if: steps.cloudflare_deploy.outcome == 'success'
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.payload.pull_request.number;
          const comment =
            `ðŸš€ **Beta Deployment Successful**\n\n` +
            `Your changes are live at: **https://beta.terraria-map-editor.com**\n\n` +
            `ðŸ“ **Note:** This is a shared beta environment. New PR deployments will overwrite this.\n\n` +
            `Commit: \`${context.payload.pull_request.head.sha.substring(0, 7)}\``;

          github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
            body: comment
          });

    - name: Comment on PR - Failure
      if: steps.cloudflare_deploy.outcome == 'failure'
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.payload.pull_request.number;
          const comment =
            `âš ï¸ **Beta Deployment Failed**\n\n` +
            `The build succeeded, but deployment to Cloudflare Pages failed.\n\n` +
            `This doesn't block your PR - you can still merge.\n\n` +
            `Check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.`;

          github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
            body: comment
          });
